<!DOCTYPE html>
<html>

<head>
<meta charset='utf-8' />
<link href='../lib/main.css' rel='stylesheet' />
<script src='../lib/main.js'></script>
<script>
	document
			.addEventListener(
					'DOMContentLoaded',
					function() {

						let xhtp = new XMLHttpRequest();
						xhtp.open('get', '../../GetScheduleServlet'); // selectable.html  상위 상위.
						xhtp.send();
						xhtp.onload = function() {

							// json -> object.
							let result = JSON.parse(xhtp.responseText);
							console.log(result);

							var calendarEl = document
									.getElementById('calendar');

							let dbData = result; //[{},{}]

							var calendar = new FullCalendar.Calendar(
									calendarEl,
									{
										headerToolbar : {
											left : 'prev,next today',
											center : 'title',
											right : 'dayGridMonth,timeGridWeek,timeGridDay'
										},
										initialDate : '2021-11-12',
										navLinks : true, // can click day/week names to navigate views
										selectable : true,
										selectMirror : true,
										select : function(arg) {
											var title = prompt('신규 이벤트 등록:');
											console.log(arg);
											if (title) {
												//ajax  로 db입력
												let addReq = new XMLHttpRequest();
												addReq
														.open('post',
																'../../GetScheduleServlet ');
												addReq
														.setRequestHeader(
																"Content-type",
																"application/x-www-form-urlencoded");
												addReq.send('title=' + title
														+ '&start='
														+ arg.startStr
														+ '&end=' + arg.endStr);
												addReq.onload = function() {
													let result = JSON
															.parse(addReq.responseText);
													// 정상적으로 입력처리가 되면..
													//화면에 입력값 추가.
													if ('성공') {
														calendar.addEvent({
															title : title,
															start : arg.start,
															end : arg.end,
															allDay : arg.allDay
														})
													} else {
														alert('입력처리 실패');

													}
													calendar.unselect();
												}
												//end of onload.
											} //end of if(title)
										},
										eventClick : function(arg) {
											if (confirm('Are you sure you want to delete this event?')) {
												//ajax   호출 .. db삭제
												let rmReq = new XMLHttpRequest();
												rmReq.open('get',
														'../../DeleteServlet?title='
																+ title);
												rmReq.send();

												rmReq.onload = function() {
													let result = JSON
															.parse(addReq.responseText);
													if (result.retCode == 'OK')
														arg.event.remove() //화면삭제
												}
											}
										},
										editable : true,
										dayMaxEvents : true, // allow "more" link when too many events
										events : dbData
									});

							calendar.render();

						}

					});
</script>
<style>
body {
	margin: 40px 10px;
	padding: 0;
	font-family: Arial, Helvetica Neue, Helvetica, sans-serif;
	font-size: 14px;
}

#calendar {
	max-width: 1100px;
	margin: 0 auto;
}
</style>
</head>

<body>

	<div id='calendar'></div>

</body>

</html>